#include "isog.h"
#include "ec.h"
#include <assert.h>

// -----------------------------------------------------------------------------------------
// -----------------------------------------------------------------------------------------

// Degree-2 isogeny evaluation with kenerl generated by P != (0, 0)
void
xeval_2(ec_point_t *R, ec_point_t *const Q, const int lenQ, const ec_kps2_t *kps)
{
    fp2_t t0, t1, t2;
    for (int j = 0; j < lenQ; j++) {
        fp2_add(&t0, &Q[j].x, &Q[j].z);
        fp2_sub(&t1, &Q[j].x, &Q[j].z);
        fp2_mul(&t2, &kps->K.x, &t1);
        fp2_mul(&t1, &kps->K.z, &t0);
        fp2_add(&t0, &t2, &t1);
        fp2_sub(&t1, &t2, &t1);
        fp2_mul(&R[j].x, &Q[j].x, &t0);
        fp2_mul(&R[j].z, &Q[j].z, &t1);
    }
}

void
xeval_2_singular(ec_point_t *R, const ec_point_t *Q, const int lenQ, const ec_kps2_t *kps)
{
    fp2_t t0, t1;
    for (int i = 0; i < lenQ; i++) {
        fp2_mul(&t0, &Q[i].x, &Q[i].z);
        fp2_mul(&t1, &kps->K.x, &Q[i].z);
        fp2_add(&t1, &t1, &Q[i].x);
        fp2_mul(&t1, &t1, &Q[i].x);
        fp2_sqr(&R[i].x, &Q[i].z);
        fp2_add(&R[i].x, &R[i].x, &t1);
        fp2_mul(&R[i].z, &t0, &kps->K.z);
    }
}

// Degree-4 isogeny evaluation with kenerl generated by P such that [2]P != (0, 0)
void
xeval_4(ec_point_t *R, const ec_point_t *Q, const int lenQ, const ec_kps4_t *kps)
{
    const ec_point_t *K = kps->K;

    fp2_t t0, t1;

    for (int i = 0; i < lenQ; i++) {
        fp2_add(&t0, &Q[i].x, &Q[i].z);
        fp2_sub(&t1, &Q[i].x, &Q[i].z);
        fp2_mul(&(R[i].x), &t0, &K[1].x);
        fp2_mul(&(R[i].z), &t1, &K[2].x);
        fp2_mul(&t0, &t0, &t1);
        fp2_mul(&t0, &t0, &K[0].x);
        fp2_add(&t1, &(R[i].x), &(R[i].z));
        fp2_sub(&(R[i].z), &(R[i].x), &(R[i].z));
        fp2_sqr(&t1, &t1);
        fp2_sqr(&(R[i].z), &(R[i].z));
        fp2_add(&(R[i].x), &t0, &t1);
        fp2_sub(&t0, &t0, &(R[i].z));
        fp2_mul(&(R[i].x), &(R[i].x), &t1);
        fp2_mul(&(R[i].z), &(R[i].z), &t0);
    }
}

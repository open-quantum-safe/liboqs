//
// Supersingular Isogeny Key Encapsulation Ref. Library
//
// InfoSec Global Inc., 2017
// Basil Hess <basil.hess@infosecglobal.com>
//

#include <sike_params.h>
#include <stdlib.h>

const sike_params_raw_t SIKEp503 = {
  .name = "SIKEp503",

  .p    = "0x4066F541811E1E6045C6BDDA77A4D01B9BF6C87B7E7DAF13085BDA2211E7A0ABFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
  .lA   = "2",
  .eA   = "250",
  .lB   = "3",
  .eB   = "159",

  .xQA0 = "0x97453912E12F3DAF32EEFFD618BD93D3BBBF399137BD39858CADEFAE382E42D6E60A62FD62417AD61A14B60DB26125273EC980981325D86E55C45E3BB46B1",
  .xQA1 = "0x0",
  .yQA0 = "0x9B66640A4CC79F82B68D72609233812DF76E8B0422EF3527A1F2A9915EFF16E0940040DF4A15A84A5ACF024FC2ED8A50102A731E8D20D033B48035B63DD62",
  .yQA1 = "0x0",

  .xPA0 = "0x1F6D52A7563BB9356B98A116A0CA9775DBB7382EB29E24E45299D8939959EAEEB47FF3113F60882D12103E4B8B8CD2B97DA14657AE8C128BE82209D2DDFCA9",
  .xPA1 = "0x2D44C3FAD24E4CBDDC8A2D9DE336A92A9912EE6D09E2DD5C33AB26D60A268AC91F38E1AF4C2D5BFA2B87DD55C8CA6019C6B0C08ED92B5AEB6C65A8E06E53E9",
  .yPA0 = "0x3C9F7C397283C0871F78D9F74ECC0A8F89579CCBEF8FE60D07338AF0A0322E3F0C66CA826AA5BF85EB53666C272C8EAEC9B808B3B78E6422330617AC23D6F2",
  .yPA1 = "0x38222AE95DA234ABD1B90FD897C2E2E7995B2C0006DC92CC079B7C60C94DCAE9961CC7A4BAEAC9D294F6D5760D4D654821193AE92AD42AC0047ADE55C343FC",

  .xRA0 = "0x173775ECBEC79C78FD1ED5FE36075AACE1F53F8FFB97D2A7E80DFC2875E77EC72D1D4A99E13353EC9D147BADD96126948A72B30BDD7CEBAD7B54F8DDB5CD06",
  .xRA1 = "0x2EAA224DDDA149BBBB9089D2B2C471D068ECA203465CE97DBC1C8ED0EBB0FF90E4FBE7E266BBA99CBAE051797B4D35D28E36C1B1CB994AEEED1CB59FE5015",

  .xQB0 = "0x1E7D6EBCEEC9CFC47779AFFD696A88A971CDF3EC61E009DF55CAF4B6E01903B2CD1A12089C2ECE106BDF745894C14D7E39B6997F70023E0A23B4B3787EF08F",
  .xQB1 = "0x0",
  .yQB0 = "0x2EC0AAEF9FBBDD75FBDA11DA19725F79E842FBC355071FD631C1CDF90E08E601929FAEC5DAEB0D96BBB4AD50FC7C8AD47064F05C06DC5D4AAE61CCCEFF1F26",
  .yQB1 = "0x0",

  .xPB0 = "0x21B7098B640A01D88708B729837E870CFF9DF6D4DF86D86A7409F41156CB5F7B8514822730940C9B51E0D9821B0A67DD7ED98B9793685FA2E22D6D89D66A4E",
  .xPB1 = "0x2F37F575BEBBC33851F75B7AB5D89FC3F07E4DF3CC52349804B8D17A17000A42FC6C5734B9FCFDE669730F3E8569CEB53821D3E8012F7F391F57364F402909",
  .yPB0 = "0x78F8A30AB36B301BDF672D9E3518AF741F8227CC95A9F351B99623A826DE3F8D90DD6ED42FF298E394E77B7AEFEE6010CDF34A7DE9F9E239B103E7B3EEE",
  .yPB1 = "0x37F3C600488EBB6B11462C4CAFC41CD5DC611A9B0C804E3BF50D6D8F75C4E7A136E29E00D80EB8653CA830F2AED61D04F9F3A8317F7916E016F2733B828AC0",

  //.xRB0 = "0xD4818D120A24ABF48DB51D129E6B1F24F4BBB2C16FACC0C8C06323EEEC2FA5B5E887E17226417B1907310BFE6784FDEBBAC8C2A9ABBE753F52259A7B7D70E",
  //.xRB1 = "0x19E75F0F03312D22CBBF153747525D89E5155BABB8BF0C130CB567CA532F69AAF57EA7682B9957021D90414433ABBEEDC233E9082185781C16724C8C356777",

  .crypto_bytes = 16,
  .msg_bytes = 24,
};

const sike_params_raw_t SIKEp751 = {
  .name = "SIKEp751",

  .p    = "0x6FE5D541F71C0E12909F97BADC668562B5045CB25748084E9867D6EBE876DA959B1A13F7CC76E3EC968549F878A8EEAFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
  .lA   = "2",
  .eA   = "372",
  .lB   = "3",
  .eB   = "239",

  .xQA0 = "0x3E82027A38E9429C8D36FF46BCC93FA23F89F6BE06D2B1317AD90438621783FDB7A4AD3E83E86CAE096D5DB822C98E561E008FA0E3F3B9AC2F40C56D6FA4A58A20449AF1F1335661D14AB7347693632646086CE3ACD54B0346F5CCE233E9",
  .xQA1 = "0x0",
  .yQA0 = "0x3BBF8DCD4E7EB6236F5F598D56EB5E15915A755883B7C331B043DA010E6A163A7421DFA8378D1E911F50BF3F721A8ED5950D80325A8D0F147EF3BD0CFEC5236C7FAC9E69F7FD5A99EBEC3B5B8B000F8EEA737089343012E0D620BFB341D5",
  .yQA1 = "0x0",

  .xPA0 = "0x54921C31F0DC9531CB890FC5EC66DF2E7F0D55761363C6E375DA69B0682CABE5C0FFFCBE6E1AD46563F042FA06B9F207FCF3CDD2673652828FF50C3F7B755C0BE072950D16CA747C146775C0267A401FFC738B03A49E9A36B39572AFB363",
  .xPA1 = "0x28849BC0D81E01993137A5B63D6E633C4E97AB4FF118CCF63DFE623092AC86B6D4A9B751797CBA1A177500E9EB5AF7852B7DF02C334844D652EFC4729178A1DBAD8CA47BB7E757C6D43B799811A63BEBE649C18101F03AD752CDCD73BF66",
  .yPA0 = "0x196119D87272DC3AA7223476C8C3269D48CAEFAE692F68DCF2D6E1BEB5B97525D5026C157C7C740B41ADE80A8CF2E1E0B37E5F5FD4ED88235BF7404BE39189C137E21C035EF6339D7FACBA38E72D69043710E76266A5FC14EFB95E5FBC7C",
  .yPA1 = "0xD3AC09A67D59CC8D78B0FA6681AE78BDF0C8F558E3866005E4355B0B199318D9CDD67C0A7DB234F9EA1EC4C5F1E59168B7DBD14281F09E8DF904A3D574CAD526DC5A3667490ADE1A4C13B09F7B115C4E488FD4DD5F7670B5897322AD41D",

  .xRA0 = "0x22A0B5A35A2B0C56135A7CEC5CFB97964A7C6226FE909F374362A8ECA3AB14A1B7B0C87AC875DCE5888D83B623BF0011A4AC138F62EF6B2D2D84F636548A9F920F238336E5A36E45E4055940E3C94385B8FC5374396432EEF2AE178CEFDD",
  .xRA1 = "0xF9C4AFCDA809C3358B096B250C69B20310FDF2EF631711AA4EFEC49A4E76483F320B793F2EBC63365EED14AA3F6EA33FEB56796F011BA6C6DFB4D0A00AAC4D2786646D914AD026CBB4A592EC74B5485372E51382D44528DD491B83D9547",

  .xQB0 = "0x2F1D80EF06EF960A01AB8FF409A2F8D5BCE859ED725DE145FE2D525160E0A3AD8E17B9F9238CD5E69CF26DF237429BD3778659023B9ECB610E30288A7770D3785AAAA4D646C576AECB94B919AEEDD9E1DF566C1D26D376ED2325DCC93103",
  .xQB1 = "0x0",
  .yQB0 = "0x127A46D082A1ACAF351F09AB55A15445287ED1CC55DC35892123951D4B6E302C5129C049EEB399A6EDB2EEB2F9B0A94F06CDFB3EADE76EBA0C8419745E97D12754F00E898A315B529122CFE3CA6BBC6BAF5F6BA40BB91479226A0687894",
  .yQB1 = "0x0",

  .xPB0 = "0x5FD1A3C4DD0F630974196FED3519152BC7098B9E2B121ECA46BD10A5CC9F4BCC6C689B8E4C063B3798075FCEE6EDAA9EB108B3CD00495CF04DD8CE4A08FBE685A127D40E45F4CF45098A578DEB44368699394C43BFC9BC5E00052F78E8D",
  .xPB1 = "0x2B88A03360B3389547732C9140C05DEA6516881FE108211BE887CC43FCB80C06A1D86FF5457D3BB7DB936394EC33821AA39333A60AF84B537974CFA0BA8287D699D2BF79BA559026C64A6ED610501D2357C10B9A6C8F837424922275ACBF",
  .yPB0 = "0x53B55053E3F04FC315EFB1B7B2C4AFCB4FEF12CE744AF3B243C6E6B1417E94A78D4980DDE181896464923E01AACC3DA040A0747CA67554A352684DA207C49022D930732DF6BD0BF37E1F5C16917669A70F88059C1C739A79D7CFA0C529D9",
  .yPB1 = "0x44E44196909252ECD7B9164323815294F02AED22C4E4EB43D2CE2BC5F29EB575D45CA8B6B4C4242E369AE3A1EFC844E9D1C57B0AE3374BC2CEDAD16B0C699158332E2D9AB3F0025C0348C5F70FDC4DD7C4865E64B8B843F03D807447D5E",

  //.xRB0 = "0x77B3BB69009428A327D43CA60169715F547454F88CD017B32DF58A7252C2B3C3D00D52CCD3133D54041D8BCAEA291F2057202328712CD395575CD7CCD3CE70C0A1EBF633BA946559458878F41F9FDD1727E2C31125B2FE5B71306704829",
  //.xRB1 = "0x6D91393A57DBF47FD6DCF841F17ECD719CAE1D33C6832A75B0F168855BCC38D2A4792DFF9BC86DEACA10B1AA808D539B167D73BBA32168687FA3F85AE93A1ADDE5BD1FD5B681DCC6C34454D4496976C22D80C95E42B12576FC0FB4074B9F",

  .crypto_bytes = 24,
  .msg_bytes = 32,
};

const sike_params_raw_t SIKEp964 = {
  .name = "SIKEp964",

  .p    = "0x86B5BFF7643C64F7A10028248AD4FC4B150CBAA75A2A1FA44CBAB245135469BAB093F2B8DAD5281E7E56EF6AA57A94749ABB38EAB467ACDE5451CD4BFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF",
  .lA   = "2",
  .eA   = "486",
  .lB   = "3",
  .eB   = "301",

  .xQA0 = "0x1CD5AEB4E02DBE2CEB712A45EED7720D3EA94116F1E45C834FDFF3A867BBB267BF8F5F9B19C369F7AFE141B85D591243E7310B6D02E78DB888615254DF178C1F75F2BDAF703E83BB97DBCDC3DFDB60BA385EC8F42D4AD150521ECA6EC4D3086A7783698A71544E10A45EA605E1B86A8947F14FA2E03845DAE",
  .xQA1 = "0x0",
  .yQA0 = "0x22E751F1F60841CF4E8D4D3BD8D400F589761CA1F71A9C1F383C0FE553E6492DBE1F78D5F9A768920B682786E8125398F765A481B32913561FD16B27019D9C10C4F9062AC1513FEB2FE942DD22AC53F6EC319C4D18A53A481430F3DFA22E57EDA0D067C37F91EA8F13E4B1C654E974856781F8E0A397ED362",
  .yQA1 = "0x0",

  .xPA0 = "0x6ED767E2804975D8180368FB9A72CE64E838A54974865BFF1A86AEF07D6171A8A4DF351F1D4C94AAF82BD6EBD396F334248282F5073178AB57B906BEF89A2A152A10D04A5B20A0FFF96B0B48F0599FC9BD2AD52E081BB7FEA7B5E8BF4C3B0AB130731F4C5A974CFA5AD6781217A20F9ECD30691D9D1941D03",
  .xPA1 = "0x3FE63FBDCA589518A3DA694ECC8B659346693C45BD8AC86B6F0C778CF290C9F429163FEF64AFAD182ADE1B0C4DFC8CF29C35455C7BA69C22559F2E0D420AE05BB0AE3ADC09A4A0AF28CE1A1C5931710337AA68884EFCCD60AC76FD3F17ED50205305509E05955F60D5008D788B83F5FA457FD79ECDC7179D1",
  .yPA0 = "0x4E0A866285403BC0408F9BCA912025E3171118961C8654612AE20CEEAF91A98A4F278EAEBB7046028AD90CD95B99BF6B34233CD4B084B2CA4598DF3A6D4839CA6EA493ED420CF4C13A1F37F1EC59620F08693649C72380A8479E375393D3F4A759DF65F1F74B4C656B79DF2A5DA2959EFB006BDAD015D252",
  .yPA1 = "0x7388460482319281B78C6AC1FE1A91DB72A2C9AA34BEE1EBEA33EF043AA1BFA0C4589414295E94C911E19E808246B2A0A98593958E1F70888E00332DEAE7D7FDBCA53398E59530E5D2A2924637533F46C4684373DDDB8D09B2A75C3073EA3C19ECF946FCB2B428B6E9CF93F2233DD257C5CAD40413F78CD1D",

  .xRA0 = "0x844F024B8D993B66048C9DA7F1724AE2E4C6162F84804FE3FE290FBEB5ABF7DF25C39512177C8E4A47A35F8ECD037B699E34F58EF675AE188A1537838A4DDBA69FC7BC3FACB7E3815F3031244AF1BCCE195AF45B42A587EE87A00BF2DA1E972D8D662F4DC5EC1CDB103D9EED2215D4DD7480049858925A63A",
  .xRA1 = "0x735F06B9766B69FF917835EADC539A00FFC186ED25947F701FDA7EDEAF517039F9B0DA1721FDAE9784838C75B46A452DC902EC8DD1F4625643B42C596C2CF04045A7AA8043F07C9A9F82611D202F06834512A3803EF64650E5309163F25CCC336CC8527649E340F59CDDFB51B24D1C02E8CB2653E7A05B709",

  .xQB0 = "0x381DBCAB1EE7A4CA3192CDA853F4E0F426522EB9D3277421C29D73CC4F70BEFE7009767C4AE4516003B237223422C0E752ACD9D8FCE07263D2C1D101308C0B97EDB8D4A8C53C2064B05DF9A61E8216CA1FFAC55F4CA04397252704945C27136A056F6B5CF8838B7F652BC16C1392B559736CAF63BF0058A53",
  .xQB1 = "0x0",
  .yQB0 = "0x1AFBFA81B55C7D789B6E89BC7A311F3CEE4B733B0FA5B7D56D29A644B596B7729778E0773F908D76E0377B3CA41C03D797DE4F0B7985EB5127D2151EC4B6C11361AEB4CEAA3F776E08E4AD01B7BB46074D425C8A261E88B145C4153BF67732E829986EB9D29C883851EEEB87CC4FD96A0843325426C108687",
  .yQB1 = "0x0",

  .xPB0 = "0x4FE46F0B009171C870FE840B7FD0C3F1493813CD125C2191C9FA4BDE40941A603124F1B81BBFBEBFDAC06F80807562639FC61A57962AE6E6B7EE793CF7B359746FEB0DA110D704681F83EF6B440DC5DEDD2A4247149D0A44C452ED374A394319A8888A2A09CC4A0F35A07AA3D248CF7803E77EAD2A4BEA308",
  .xPB1 = "0x6DD4FC1768E1ADEE54DC4E41CFAA7B8104644DD690616D374A9139013FD847C2CD11BA6CA4C4FC26A63FE198B666B7912FBF889E991CF4B903651F4414CD4AA50BC02CE2EC986A7BFC1A8D364F93410ADE3B959FF1F036F36EF3AFF88D28DB5008276C3402158ADB4A44BAECED2AF6503093FD8B6A58EC136",
  .yPB0 = "0x3EA8CDCF4BC1C1B9D2D449022387D4DDEF05CE98CB63E722B0EA14717C5FFA82EE107832E5FE58C2890185D2C90D1BD94AC13C69FD483AC8066B1F1A4844F7655884B23790088A6DA915FD709EFE79A88028108F4D4DFBFADBA65EFBBC5D621BA31F12BE6FB717D3B1D8CD78DCD05B0D2B7E87C103D1897C0",
  .yPB1 = "0x777607A2185C04FBFCFA5EAF77F38F40F42746739748CA176BBE317394BDA28F3D971DFB9CCB67207E201FFB00A9A3E6B9B7E804FBB6EF61ECEBDB8AC68831E10E8A72613A47F132BD9A2309E404FCFFF7EA7BC87AD448B8B8798AB61CA6F97DB3B2408879DEB8A9F930C4EE469486FA1129E89B67C084CD9",

  //.xRB0 = "0x7DE290085EBBDC801A1D6292D1F2E89FF463669ED2F5F6C02B8010A75245C4D3984002821B8A243C756512A5FC1FC0867A84583D76B0404E7E73CEB7071E2AE3BF43BFB77A87BC98FDF888E285CD4A3C94E4D1795009E41EDB8A3AD8F81321138E4A87B69416AEFF094E541F48681863BAD30FB2F32EA019A",
  //.xRB1 = "0x7A2A2DFA4FB56733660ACCB80308A4482B1A46D3B9BB20313F164CC809A3A6B4D2FBC43574994354DC06D409F9F647E82F4F05D6C5A70E340DF4B95559787F82EAD7F7295590FDCD9D54B8001094DC80929EF4C5ABB8E388A53AA0BD388D890B5980F1FD19404025B582C640DDFDA1BDF46D370464A812732",

  .crypto_bytes = 32,
  .msg_bytes = 40,
};

void
sike_setup_params(const sike_params_raw_t *raw, sike_params_t *params) {
  // Base curve -> Coefficients are null
  mont_curve_int_t* EA = &params->EA;
  mont_curve_int_t* EB = &params->EB;

  params->eA = (unsigned long) strtol(raw->eA, NULL, 0);
  params->eB = (unsigned long) strtol(raw->eB, NULL, 0);

  params->lA = (unsigned long) strtol(raw->lA, NULL, 0);
  params->lB = (unsigned long) strtol(raw->lB, NULL, 0);

  ff_Params* ffpA = malloc(sizeof(ff_Params));
  ff_Params* ffpB = malloc(sizeof(ff_Params));


  set_gmp_fp_params(ffpA);
  set_gmp_fp_params(ffpB);

  EA->ffData = ffpA;

  fp_Init(ffpA, params->p);
  fp_ImportHex(raw->p, params->p);

  fp_Init(ffpA, params->ordA);

  mp_pow(params->lA, params->eA, params->ordA);
  params->msbA = mp_sizeinbase(params->ordA, 2);

  fp_Init(ffpA,  EA->ffData->mod);

  fp_Init(ffpA, EA->P.x.x0);
  fp_Init(ffpA, EA->P.x.x1);
  fp_Init(ffpA, EA->P.y.x0);
  fp_Init(ffpA, EA->P.y.x1);
  fp_Init(ffpA, EA->Q.x.x0);
  fp_Init(ffpA, EA->Q.x.x1);
  fp_Init(ffpA, EA->Q.y.x0);
  fp_Init(ffpA, EA->Q.y.x1);

  fp_ImportHex(raw->p,    EA->ffData->mod);


  fp_ImportHex(raw->xPA0, EA->P.x.x0);
  fp_ImportHex(raw->xPA1, EA->P.x.x1);
  fp_ImportHex(raw->yPA0, EA->P.y.x0);
  fp_ImportHex(raw->yPA1, EA->P.y.x1);
  fp_ImportHex(raw->xQA0, EA->Q.x.x0);
  fp_ImportHex(raw->xQA1, EA->Q.x.x1);
  fp_ImportHex(raw->yQA0, EA->Q.y.x0);
  fp_ImportHex(raw->yQA1, EA->Q.y.x1);

  fp2_Init_set(ffpA, &EA->a, 0, 0);
  fp2_Init_set(ffpB, &EA->b, 1, 0);

  EB->ffData = ffpB;

  fp_Init(ffpB, params->ordB);

  mp_pow(params->lB, params->eB, params->ordB);
  params->msbB = mp_sizeinbase(params->ordB, 2);

  fp_Init(ffpB, EB->ffData->mod);

  fp_Init(ffpB, EB->P.x.x0);
  fp_Init(ffpB, EB->P.x.x1);
  fp_Init(ffpB, EB->P.y.x0);
  fp_Init(ffpB, EB->P.y.x1);
  fp_Init(ffpB, EB->Q.x.x0);
  fp_Init(ffpB, EB->Q.x.x1);
  fp_Init(ffpB, EB->Q.y.x0);
  fp_Init(ffpB, EB->Q.y.x1);

  fp_ImportHex(raw->p,    EB->ffData->mod);

  fp_ImportHex(raw->xPB0, EB->P.x.x0);
  fp_ImportHex(raw->xPB1, EB->P.x.x1);
  fp_ImportHex(raw->yPB0, EB->P.y.x0);
  fp_ImportHex(raw->yPB1, EB->P.y.x1);
  fp_ImportHex(raw->xQB0, EB->Q.x.x0);
  fp_ImportHex(raw->xQB1, EB->Q.x.x1);
  fp_ImportHex(raw->yQB0, EB->Q.y.x0);
  fp_ImportHex(raw->yQB1, EB->Q.y.x1);

  fp2_Init_set(ffpB, &EB->a, 0, 0);
  fp2_Init_set(ffpB, &EB->b, 1, 0);

  params->crypto_bytes = raw->crypto_bytes;
  params->msg_bytes = raw->msg_bytes;
}

void
sike_teardown_params(sike_params_t *params) {

  mont_curve_int_t* EA = &params->EA;
  mont_curve_int_t* EB = &params->EB;

  ff_Params* ffpA = EA->ffData;
  ff_Params* ffpB = EB->ffData;

  fp_Clear(ffpA, params->p);

  fp_Clear(ffpA,  EA->ffData->mod);
  fp_Clear(ffpA,  params->ordA);

  fp_Clear(ffpA, EA->P.x.x0);
  fp_Clear(ffpA, EA->P.x.x1);
  fp_Clear(ffpA, EA->P.y.x0);
  fp_Clear(ffpA, EA->P.y.x1);
  fp_Clear(ffpA, EA->Q.x.x0);
  fp_Clear(ffpA, EA->Q.x.x1);
  fp_Clear(ffpA, EA->Q.y.x0);
  fp_Clear(ffpA, EA->Q.y.x1);

  fp2_Clear(ffpA, &EA->a);
  fp2_Clear(ffpB, &EA->b);

  fp_Clear(ffpB, EB->ffData->mod);
  fp_Clear(ffpB, params->ordB);

  fp_Clear(ffpB, EB->P.x.x0);
  fp_Clear(ffpB, EB->P.x.x1);
  fp_Clear(ffpB, EB->P.y.x0);
  fp_Clear(ffpB, EB->P.y.x1);
  fp_Clear(ffpB, EB->Q.x.x0);
  fp_Clear(ffpB, EB->Q.x.x1);
  fp_Clear(ffpB, EB->Q.y.x0);
  fp_Clear(ffpB, EB->Q.y.x1);

  fp2_Clear(ffpB, &EB->a);
  fp2_Clear(ffpB, &EB->b);

  free(ffpA);
  free(ffpB);
}
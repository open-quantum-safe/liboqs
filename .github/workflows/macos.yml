name: MacOS tests

on: [push, pull_request] # TODO eliminate double-run

jobs:
  macos:
    runs-on: [macos-12, macos-13, macos-14]
    strategy:
      matrix:
        include:
          - name: macOS-gcc13
            CMAKE_ARGS: -DCMAKE_C_COMPILER=gcc-13
          - name: macOS-noopenssl
            CMAKE_ARGS: -DOQS_USE_OPENSSL=OFF
          - name: macOS-buildshared
            CMAKE_ARGS: -DBUILD_SHARED_LIBS=ON -DOQS_DIST_BUILD=OFF
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install dependencies
        run: env HOMEBREW_NO_AUTO_UPDATE=1 brew install ninja && pip3 install pytest pytest-xdist pyyaml
      - name: Get system information
        run: sysctl -a | grep machdep.cpu
      - name: Configure
        run: mkdir build && cd build && source ~/.bashrc && cmake -GNinja -DOQS_STRICT_WARNINGS=ON ${{ matrix.CMAKE_ARGS }} .. && cmake -LA ..
      - name: Build
        run: ninja
        working-directory: build
      - name: Run tests
        run: mkdir -p tmp && python3 -m pytest --verbose --num-processes=auto --ignore=tests/test_code_conventions.py --ignore=tests/test_kat_all.py ${{ matrix.PYTEST_ARGS }}
        timeout-minutes: 60

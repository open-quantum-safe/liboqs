version: 1.0.{build}

# TODO: Support Visual Studio 2017
image: Visual Studio 2019

platform: x64

branches:
  except:
    - /master-new-.*/

init:
  - set PATH="C:\\Python37";"C:\\Python37\Scripts";%PATH%

environment:
  matrix:
    - BUILD_SHARED: OFF
    - BUILD_SHARED: ON

before_build:
  - cmd: |-
      mkdir build
      cd build
      cmake .. -G"Visual Studio 16 2019" -DBUILD_SHARED_LIBS=%BUILD_SHARED%
build:
  project: build\ALL_BUILD.vcxproj
  verbosity: minimal

before_test:
  - python -m pip install pytest pytest-xdist

test_script:
  - msbuild %APPVEYOR_BUILD_FOLDER%\build\run_tests.vcxproj

after_test:
  - ps: >-
      $wc = New-Object 'System.Net.WebClient'

      $wc.UploadFile("https://ci.appveyor.com/api/testresults/xunit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\build\test-results\pytest\results.xml))
